<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Pro v98 - Universal Surveyor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --brand: #e67e22; --dark: #1e293b; --danger: #e74c3c; --success: #27ae60; --blue: #3498db; }
        body { margin: 0; background: #0f172a; font-family: 'Segoe UI', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        #map { flex-grow: 1; background: #111; cursor: crosshair; }
        
        /* MenÃ¼ Stilleri */
        .sidebar { position: absolute; left: 10px; top: 10px; width: 350px; background: rgba(255,255,255,0.98); z-index: 2000; border-radius: 12px; padding: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border-top: 6px solid var(--brand); max-height: 85vh; overflow-y: auto; }
        .box { background: #f8fafc; padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid #e2e8f0; }
        .title { font-size: 11px; font-weight: 900; color: #64748b; text-transform: uppercase; margin-bottom: 8px; display: block; border-bottom: 1px solid #e2e8f0; padding-bottom: 4px; }
        
        .btn { width: 100%; padding: 8px; margin: 3px 0; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; color: white; background: #475569; transition: 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-active { background: var(--success) !important; box-shadow: 0 0 10px rgba(39,174,96,0.3); }
        .btn-export { background: #2c3e50; }
        
        /* Koordinat Tablosu */
        #table-container { height: 200px; background: white; z-index: 2100; overflow-y: auto; border-top: 4px solid var(--dark); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: monospace; }
        th { background: #f1f5f9; padding: 8px; position: sticky; top: 0; border-bottom: 2px solid #cbd5e1; }
        td { padding: 4px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        .edit-input { width: 85%; border: 1px solid #ddd; padding: 2px; text-align: center; border-radius: 4px; font-size: 11px; }

        .cad-label { font-weight: bold; text-shadow: 1px 1px 0 #000; font-size: 12px; color: #fff; pointer-events: none; }
        .measure-tip { background: black; color: white; padding: 2px 5px; border-radius: 4px; font-size: 10px; border: 1px solid var(--brand); }
    </style>
</head>
<body>

<div id="map"></div>

<div class="sidebar">
    <div class="box">
        <span class="title">ğŸ“¥ Ä°Ã‡ERÄ° AKTAR</span>
        <input type="file" id="fileInput" onchange="importData(this)" style="font-size:10px; width:100%;">
    </div>

    <div class="box">
        <span class="title">ğŸ“¤ DIÅARI AKTAR</span>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
            <button class="btn btn-export" onclick="exportData('dxf')">AutoCAD (DXF)</button>
            <button class="btn btn-export" onclick="exportData('ncn')">Netcad (NCN)</button>
            <button class="btn btn-export" onclick="exportData('excel')">Excel (CSV)</button>
            <button class="btn btn-export" onclick="exportData('kml')">Google (KML)</button>
        </div>
    </div>

    <div class="box">
        <span class="title">ğŸ› ï¸ DÃœZENLEME ARAÃ‡LARI</span>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px;">
            <button id="addBtn" class="btn" onclick="setMode('add')">â• NOKTA AT</button>
            <button id="lineBtn" class="btn" onclick="setMode('line')">ğŸ“ HAT Ã‡Ä°Z</button>
            <button id="delLineBtn" class="btn" style="background:var(--danger)" onclick="setMode('delLine')">ğŸ—‘ï¸ HAT SÄ°L</button>
            <button id="measureBtn" class="btn" style="background:#8e44ad" onclick="setMode('measure')">ğŸ“ Ã–LÃ‡ÃœM</button>
        </div>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:4px; margin-top:5px;">
            <button class="btn" style="background:var(--success)" onclick="autoLink('id')">ğŸ”— NO SIRALI</button>
            <button class="btn" style="background:var(--blue)" onclick="autoLink('dist')">ğŸ“ EN YAKIN</button>
        </div>
    </div>

    <div class="box">
        <span class="title">ğŸ¨ GÃ–RÃœNÃœM AYARLARI</span>
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:11px; margin-bottom:5px;">
            <span>Nokta Boyu:</span>
            <input type="range" id="ptSize" min="2" max="15" value="6" oninput="render()">
        </div>
        <select id="labelType" onchange="render()" style="width:100%; font-size:11px; padding:4px;">
            <option value="id">Nokta Ä°simlerini GÃ¶ster</option>
            <option value="z">KotlarÄ± (Z) GÃ¶ster</option>
            <option value="none">Etiketleri Kapat</option>
        </select>
    </div>

    <button class="btn" style="background:#000; border:1px solid var(--brand)" onclick="zoomFit()">ğŸ¯ EKRANA SIÄDIR</button>
</div>

<div id="table-container">
    <table>
        <thead>
            <tr><th>AD</th><th>Y (DOÄU)</th><th>X (KUZEY)</th><th>Z (KOT)</th><th>Ä°ÅLEM</th></tr>
        </thead>
        <tbody id="tBody"></tbody>
    </table>
</div>

<script>
let pts = [], lns = [];
let map, ptL, lnL, msL;
let mode = 'idle', msStart = null, lnStartIdx = null;

function init() {
    map = L.map('map', { crs: L.CRS.Simple, minZoom: -100, zoomControl: false });
    ptL = L.layerGroup().addTo(map);
    lnL = L.layerGroup().addTo(map);
    msL = L.layerGroup().addTo(map);
    map.setView([0, 0], 2);
    map.on('click', onMapClick);
}
init();

// --- IMPORT SÄ°STEMÄ° ---
function importData(input) {
    const file = input.files[0];
    if (!file) return;
    const reader = new FileReader();
    const ext = file.name.split('.').pop().toLowerCase();

    reader.onload = (e) => {
        const raw = e.target.result;
        if (ext === 'ncn') parseNCN(raw);
        else if (ext === 'dxf') parseDXF(raw);
        else if (ext === 'kml') parseKML(raw);
        render(); zoomFit();
    };
    reader.readAsText(file, "windows-1254");
}

function parseNCN(data) {
    data.split(/\r?\n/).forEach(line => {
        const d = line.trim().replace(',', '.').split(/\s+/);
        if (d.length >= 3) pts.push({ id: d[0], y: parseFloat(d[1]), x: parseFloat(d[2]), z: parseFloat(d[3] || 0) });
    });
}

function parseDXF(data) {
    const lines = data.split(/\r?\n/).map(l => l.trim());
    for (let i = 0; i < lines.length; i++) {
        if (lines[i] === "POINT") {
            let p = { id: "P" + (pts.length + 1), x: 0, y: 0, z: 0 };
            while (i < lines.length && lines[i] !== "0") {
                if (lines[i] === "10") p.x = parseFloat(lines[++i]);
                if (lines[i] === "20") p.y = parseFloat(lines[++i]);
                if (lines[i] === "30") p.z = parseFloat(lines[++i]);
                i++;
            }
            pts.push(p); i--;
        }
    }
}

function parseKML(data) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(data, "text/xml");
    const pms = xml.getElementsByTagName("Placemark");
    for (let pm of pms) {
        let name = pm.getElementsByTagName("name")[0]?.textContent || "KML_P";
        let coord = pm.getElementsByTagName("coordinates")[0]?.textContent.trim().split(",");
        if (coord.length >= 2) pts.push({ id: name, x: parseFloat(coord[0]), y: parseFloat(coord[1]), z: parseFloat(coord[2] || 0) });
    }
}

// --- OTOMATÄ°K BAÄLAMA ---
function autoLink(type) {
    if (pts.length < 2) return;
    if (type === 'id') {
        let sorted = [...pts].sort((a, b) => a.id.localeCompare(b.id, undefined, { numeric: true }));
        for (let i = 0; i < sorted.length - 1; i++) lns.push({ from: sorted[i], to: sorted[i + 1] });
    } else {
        let unvisited = [...pts], current = unvisited.shift();
        while (unvisited.length > 0) {
            let nearestIdx = 0, minDist = Infinity;
            unvisited.forEach((p, i) => {
                let d = Math.sqrt(Math.pow(current.x - p.x, 2) + Math.pow(current.y - p.y, 2));
                if (d < minDist) { minDist = d; nearestIdx = i; }
            });
            let next = unvisited.splice(nearestIdx, 1)[0];
            lns.push({ from: current, to: next });
            current = next;
        }
    }
    render();
}

// --- RENDER VE TABLO ---
function render() {
    ptL.clearLayers(); lnL.clearLayers();
    const lType = document.getElementById('labelType').value;
    const pSize = document.getElementById('ptSize').value;
    const tBody = document.getElementById('tBody');
    tBody.innerHTML = "";

    lns.forEach((l, idx) => {
        const poly = L.polyline([[l.from.y, l.from.x], [l.to.y, l.to.x]], { color: '#27ae60', weight: 2.5 }).addTo(lnL);
        poly.on('click', (e) => {
            if (mode === 'delLine') { L.DomEvent.stopPropagation(e); lns.splice(idx, 1); render(); }
        });
    });

    pts.forEach((p, i) => {
        const marker = L.marker([p.y, p.x], {
            draggable: true,
            icon: L.divIcon({
                className: 'pt-icon',
                html: `<div style="width:${pSize*2}px; height:${pSize*2}px; background:var(--blue); border:2px solid white; border-radius:50%;"></div>`,
                iconSize: [pSize*2, pSize*2], iconAnchor: [pSize, pSize]
            })
        }).addTo(ptL);

        if (lType !== 'none') {
            marker.bindTooltip(String(lType === 'z' ? p.z.toFixed(2) : p.id), { permanent: true, direction: 'top', className: 'cad-label' });
        }

        marker.on('drag', (e) => {
            const pos = e.target.getLatLng();
            pts[i].y = pos.lat; pts[i].x = pos.lng;
            document.getElementById(`y-${i}`).innerText = pos.lat.toFixed(3);
            document.getElementById(`x-${i}`).innerText = pos.lng.toFixed(3);
        });
        marker.on('dragend', render);
        marker.on('click', (e) => { L.DomEvent.stopPropagation(e); handlePtClick(i); });

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="edit-input" value="${p.id}" onchange="pts[${i}].id=this.value; render()"></td>
            <td id="y-${i}">${p.y.toFixed(3)}</td><td id="x-${i}">${p.x.toFixed(3)}</td>
            <td><input type="number" step="0.01" class="edit-input" value="${p.z}" onchange="pts[${i}].z=parseFloat(this.value); render()"></td>
            <td><button onclick="pts.splice(${i},1); render()" style="color:red; background:none; border:none; cursor:pointer;">âœ–</button></td>
        `;
        tBody.appendChild(row);
    });
}

function handlePtClick(i) {
    if (mode === 'line') {
        if (lnStartIdx === null) lnStartIdx = i;
        else { lns.push({ from: pts[lnStartIdx], to: pts[i] }); lnStartIdx = null; render(); }
    }
}

function onMapClick(e) {
    if (mode === 'add') {
        pts.push({ id: "P" + (pts.length + 1), y: e.latlng.lat, x: e.latlng.lng, z: 0 });
        render();
    } else if (mode === 'measure') {
        if (!msStart) msStart = e.latlng;
        else {
            const d = Math.sqrt(Math.pow(msStart.lat - e.latlng.lat, 2) + Math.pow(msStart.lng - e.latlng.lng, 2));
            L.polyline([msStart, e.latlng], { color: 'yellow', weight: 2, dashArray: '5,5' }).addTo(msL);
            L.marker([(msStart.lat + e.latlng.lat)/2, (msStart.lng + e.latlng.lng)/2], {
                icon: L.divIcon({ className: 'measure-tip', html: d.toFixed(2) + "m" })
            }).addTo(msL);
            msStart = null;
        }
    }
}

function setMode(m) {
    mode = (mode === m) ? 'idle' : m; msStart = null; lnStartIdx = null; msL.clearLayers();
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-active'));
    if (mode !== 'idle') document.getElementById(m + 'Btn')?.classList.add('btn-active');
}

// --- EXPORT SÄ°STEMÄ° ---
function exportData(type) {
    if (!pts.length) return alert("Veri yok!");
    let out = "", fn = `Proje_Aktarim.${type}`;

    if (type === 'dxf') {
        out = "0\nSECTION\n2\nENTITIES\n";
        pts.forEach(p => {
            out += `0\nPOINT\n8\nNOKTALAR\n10\n${p.x}\n20\n${p.y}\n30\n${p.z}\n`;
            out += `0\nTEXT\n8\nISIMLER\n10\n${p.x+0.2}\n20\n${p.y+0.2}\n40\n0.5\n1\n${p.id}\n`;
        });
        lns.forEach(l => out += `0\nLINE\n8\nHATLAR\n10\n${l.from.x}\n20\n${l.from.y}\n11\n${l.to.x}\n21\n${l.to.y}\n`);
        out += "0\nENDSEC\n0\nEOF";
    } else if (type === 'ncn') {
        out = pts.map(p => `${p.id} ${p.y.toFixed(3)} ${p.x.toFixed(3)} ${p.z.toFixed(3)}`).join("\n");
    } else if (type === 'excel') {
        out = "Nokta_No,Y_Dogu,X_Kuzey,Z_Kot\n" + pts.map(p => `${p.id},${p.y.toFixed(3)},${p.x.toFixed(3)},${p.z}`).join("\n");
        fn = "Koordinat_Listesi.csv";
    } else if (type === 'kml') {
        out = `<?xml version="1.0" encoding="UTF-8"?><kml><Document>` + 
              pts.map(p => `<Placemark><name>${p.id}</name><Point><coordinates>${p.x},${p.y},${p.z}</coordinates></Point></Placemark>`).join("") + 
              `</Document></kml>`;
    }

    const blob = new Blob([out], { type: 'text/plain' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = fn; a.click();
}

function zoomFit() {
    if (pts.length) map.fitBounds(L.featureGroup(pts.map(p => L.circleMarker([p.y, p.x]))).getBounds(), { padding: [50, 50] });
}
</script>
</body>
</html>