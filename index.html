<!DOCTYPE html>
<html lang="tr">
<head>
    <a href="https://hits.seeyoufarm.com">
  <img src="https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Felcaptein.github.io%2FCadGis%2F&count_bg=%2379C83D&title_bg=%23555555&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false"/>
</a>
    <meta charset="UTF-8">
    <title>CAD Pro v2.0 - Ultimate Surveyor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --brand: #e67e22; --dark: #2c3e50; --bg: #ecf0f1; --highlight: #f1c40f; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #333; overflow: hidden; }
        
        #map { flex-grow: 1; cursor: crosshair; background: #1a1a1a; }
        
        /* Sol Panel */
        .sidebar { position: absolute; top: 10px; left: 10px; width: 340px; background: rgba(255,255,255,0.98); padding: 10px; border-radius: 8px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.6); max-height: 90vh; overflow-y: auto; border-left: 5px solid var(--brand); }
        .section-title { font-size: 11px; font-weight: 800; color: #7f8c8d; border-bottom: 2px solid #ecf0f1; margin: 10px 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .btn { width: 100%; padding: 7px; margin: 3px 0; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; font-size: 11px; transition: 0.2s; background: #34495e; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .btn-active { background: var(--brand) !important; box-shadow: inset 0 0 0 2px white; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .btn-small { font-size: 10px; padding: 4px; }

        /* Stil Kontrolleri */
        .style-control { display: flex; align-items: center; justify-content: space-between; font-size: 11px; margin-bottom: 4px; }
        input[type=range] { width: 60px; }
        input[type=color] { border: none; width: 25px; height: 20px; cursor: pointer; padding: 0; }
        
        /* Alt Tablo */
        #table-wrapper { height: 25vh; background: white; z-index: 2000; overflow: auto; border-top: 4px solid var(--dark); position: relative; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: 'Consolas', monospace; }
        th { position: sticky; top: 0; background: #bdc3c7; padding: 6px; z-index: 10; border-bottom: 2px solid #7f8c8d; }
        td { padding: 4px; border-bottom: 1px solid #eee; text-align: center; }
        .selected-row { background-color: var(--highlight) !important; font-weight: bold; }
        input.coord-inp { width: 90%; text-align: center; border: 1px solid #ddd; padding: 2px; border-radius: 3px; }

        /* AnlÄ±k Delta Kutusu */
        #delta-box { position: absolute; bottom: 26vh; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; z-index: 3000; display: none; border: 1px solid var(--highlight); pointer-events: none; }
        
        .cad-label { font-weight: bold; color: #fff; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000; font-size: 11px; background: none; border: none; box-shadow: none; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="delta-box">Î”Y: 0.00 | Î”X: 0.00</div>

<div class="sidebar">
    <div class="section-title">ğŸ¨ STÄ°L VE GÃ–RÃœNÃœM</div>
    <div class="style-control">
        <span>Nokta Boyutu:</span>
        <input type="range" id="ptSize" min="4" max="20" value="8" oninput="renderStylesOnly()">
        <input type="color" id="ptColor" value="#3498db" onchange="renderStylesOnly()">
    </div>
    <div class="style-control">
        <span>Hat KalÄ±nlÄ±ÄŸÄ±:</span>
        <input type="range" id="lnWidth" min="1" max="10" value="2" oninput="renderStylesOnly()">
        <input type="color" id="lnColor" value="#2ecc71" onchange="renderStylesOnly()">
    </div>
    <div class="style-control">
        <span>Etiket:</span>
        <select id="labelMode" onchange="render()" style="font-size:10px; padding:2px;">
            <option value="id">Nokta No</option>
            <option value="z">Kot (Z)</option>
            <option value="both">No + Kot</option>
            <option value="none">Yok</option>
        </select>
    </div>

    <div class="section-title">ğŸ”— OTOMATÄ°K HAT Ã‡Ä°ZÄ°MÄ°</div>
    <div class="btn-row">
        <button class="btn" style="background:#8e44ad" onclick="autoLink('seq')">ğŸ”„ SIRALI (NCN)</button>
        <button class="btn" style="background:#d35400" onclick="autoLink('near')">ğŸ“ EN YAKIN (MÄ°N/MAX)</button>
    </div>

    <div class="section-title">ğŸ› ï¸ Ã‡Ä°ZÄ°M ARAÃ‡LARI</div>
    <div class="btn-row">
        <button id="btn-add" class="btn" onclick="setMode('add')">â• NOKTA</button>
        <button id="btn-line" class="btn" onclick="setMode('line')">ğŸ“ HAT Ã‡Ä°Z</button>
    </div>
    <div class="btn-row">
        <button id="btn-delPt" class="btn btn-red" style="background:#c0392b" onclick="setMode('delPt')">âœ– NOKTA SÄ°L</button>
        <button id="btn-delLine" class="btn btn-red" style="background:#c0392b" onclick="setMode('delLine')">âœ‚ HAT SÄ°L</button>
    </div>

    <div class="section-title">ğŸ“‚ DOSYA Ä°ÅLEMLERÄ°</div>
    <div class="btn-row">
        <button class="btn" style="background:#2980b9" onclick="document.getElementById('fileIn').click()">ğŸ“¥ Ä°Ã‡E AKTAR (TÃ¼mÃ¼)</button>
        <input type="file" id="fileIn" hidden onchange="loadFile(this)" accept=".ncn,.txt,.xyz,.csv,.kml,.geojson,.json">
    </div>
    <div class="section-title" style="margin-top:5px; border:none; font-size:10px;">DIÅA AKTAR</div>
    <div class="btn-row">
        <button class="btn btn-small" style="background:#27ae60" onclick="exportData('xls')">XLS (Excel)</button>
        <button class="btn btn-small" style="background:#34495e" onclick="exportData('dxf')">DXF (Cad)</button>
    </div>
    <div class="btn-row">
        <button class="btn btn-small" style="background:#7f8c8d" onclick="exportData('ncn')">NCN (Netcad)</button>
        <button class="btn btn-small" style="background:#7f8c8d" onclick="exportData('xyz')">XYZ</button>
    </div>
    <div class="btn-row">
        <button class="btn btn-small" style="background:#e67e22" onclick="exportData('kml')">KML (Google)</button>
        <button class="btn btn-small" style="background:#8e44ad" onclick="exportData('geojson')">GeoJSON</button>
        <button class="btn btn-small" style="background:#95a5a6" onclick="exportData('csv')">CSV</button>
    </div>
    
    <button class="btn" style="background:#000; margin-top:10px;" onclick="zoomAll()">ğŸ¯ EKRANA SIÄDIR</button>
</div>

<div id="table-wrapper">
    <table id="coordTable">
        <thead>
            <tr><th>NO</th><th>Y (DOÄU)</th><th>X (KUZEY)</th><th>Z</th><th>Ä°ÅLEM</th></tr>
        </thead>
        <tbody id="tBody"></tbody>
    </table>
</div>

<script>
// --- GLOBAL DEÄÄ°ÅKENLER ---
let pts = []; // {id, y, x, z, leafletMarker}
let lns = []; // {from, to, leafletPoly} (Obje referanslarÄ±)
let map, lyrPts, lyrLns;
let mode = 'idle';
let lineStartPt = null;
let dragStartPos = null;

// --- BAÅLATMA ---
function init() {
    map = L.map('map', { crs: L.CRS.Simple, minZoom: -5, zoomControl: false });
    lyrLns = L.layerGroup().addTo(map);
    lyrPts = L.layerGroup().addTo(map);
    map.setView([0, 0], 0);

    map.on('click', onMapClick);
    document.addEventListener('keydown', (e) => {
        if(e.key === "Escape") { setMode('idle'); alert("Mod Ä°ptal Edildi."); }
    });
}

// --- RENDER MOTORU ---
function render() {
    lyrPts.clearLayers();
    lyrLns.clearLayers();
    const tBody = document.getElementById('tBody');
    tBody.innerHTML = '';
    
    // Stil AyarlarÄ±
    const pSize = document.getElementById('ptSize').value;
    const pColor = document.getElementById('ptColor').value;
    const lWidth = document.getElementById('lnWidth').value;
    const lColor = document.getElementById('lnColor').value;
    const lblMode = document.getElementById('labelMode').value;

    // 1. HatlarÄ± Ã‡iz
    lns.forEach((lineObj, idx) => {
        const poly = L.polyline(
            [[lineObj.from.y, lineObj.from.x], [lineObj.to.y, lineObj.to.x]], 
            { color: lColor, weight: parseInt(lWidth), opacity: 0.8 }
        ).addTo(lyrLns);
        
        lineObj.leafletPoly = poly; // ReferansÄ± sakla

        poly.on('click', (e) => {
            if (mode === 'delLine') {
                L.DomEvent.stopPropagation(e);
                if(confirm("Hat silinsin mi?")) { lns.splice(idx, 1); render(); }
            }
        });
    });

    // 2. NoktalarÄ± Ã‡iz
    pts.forEach((p, i) => {
        const iconHtml = `<div id="pt-icon-${i}" style="
            width:${pSize}px; height:${pSize}px; 
            background:${pColor}; 
            border:2px solid white; 
            border-radius:50%; 
            box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>`;

        const marker = L.marker([p.y, p.x], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-pt',
                html: iconHtml,
                iconSize: [pSize, pSize],
                iconAnchor: [pSize/2, pSize/2]
            })
        }).addTo(lyrPts);

        p.leafletMarker = marker; // Marker referansÄ±nÄ± sakla

        // Etiketleme
        let lblText = "";
        if(lblMode === 'id') lblText = p.id;
        else if(lblMode === 'z') lblText = p.z;
        else if(lblMode === 'both') lblText = `${p.id}\n${p.z}`;
        
        if(lblMode !== 'none') {
            marker.bindTooltip(String(lblText), { 
                permanent: true, direction: "top", className: "cad-label", offset: [0, -pSize/2] 
            });
        }

        // --- DINAMIK SURUKLEME MANTIGI ---
        marker.on('dragstart', (e) => {
            dragStartPos = e.target.getLatLng();
            document.getElementById('delta-box').style.display = 'block';
            highlightRow(i);
        });

        marker.on('drag', (e) => {
            const curr = e.target.getLatLng();
            // 1. KoordinatlarÄ± gÃ¼ncelle (Bellekteki)
            pts[i].y = curr.lat;
            pts[i].x = curr.lng;

            // 2. Tablo inputlarÄ±nÄ± anlÄ±k gÃ¼ncelle
            document.getElementById(`iy-${i}`).value = curr.lat.toFixed(3);
            document.getElementById(`ix-${i}`).value = curr.lng.toFixed(3);

            // 3. Delta kutusunu gÃ¼ncelle
            const dY = (curr.lat - dragStartPos.lat) * 100; // cm
            const dX = (curr.lng - dragStartPos.lng) * 100; // cm
            document.getElementById('delta-box').innerHTML = `<b>${p.id}</b> Î”Y:${dY.toFixed(1)}cm | Î”X:${dX.toFixed(1)}cm`;

            // 4. BAÄLI HATLARI GÃœNCELLE (Performans iÃ§in sadece ilgili hatlar)
            updateConnectedLines(p);
        });

        marker.on('dragend', (e) => {
            document.getElementById('delta-box').style.display = 'none';
        });

        marker.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if (mode === 'delPt') { deletePoint(i); return; }
            if (mode === 'line') { handleLineClick(p); return; }
            highlightRow(i);
        });

        // Tablo SatÄ±rÄ±
        const tr = document.createElement('tr');
        tr.id = `row-${i}`;
        tr.innerHTML = `
            <td><input class="coord-inp" value="${p.id}" onchange="pts[${i}].id=this.value;render()"></td>
            <td><input id="iy-${i}" class="coord-inp" type="number" step="0.01" value="${p.y.toFixed(3)}" onchange="updatePtFromTable(${i}, 'y', this.value)"></td>
            <td><input id="ix-${i}" class="coord-inp" type="number" step="0.01" value="${p.x.toFixed(3)}" onchange="updatePtFromTable(${i}, 'x', this.value)"></td>
            <td><input class="coord-inp" type="number" step="0.01" value="${p.z}" onchange="pts[${i}].z=parseFloat(this.value);render()"></td>
            <td><button onclick="deletePoint(${i})" style="color:red;border:none;background:none;cursor:pointer;">ğŸ—‘ï¸</button></td>
        `;
        tBody.appendChild(tr);
    });
}

// Sadece stil deÄŸiÅŸince komple render yapmamak iÃ§in (HÄ±z iÃ§in)
function renderStylesOnly() {
    const pSize = document.getElementById('ptSize').value;
    const pColor = document.getElementById('ptColor').value;
    const lWidth = document.getElementById('lnWidth').value;
    const lColor = document.getElementById('lnColor').value;

    pts.forEach((p, i) => {
        const div = document.getElementById(`pt-icon-${i}`);
        if(div) {
            div.style.width = pSize + 'px';
            div.style.height = pSize + 'px';
            div.style.background = pColor;
        }
        if(p.leafletMarker) {
            // Ä°kon Ã§apasÄ±nÄ± gÃ¼ncellemek gerekirse yeniden oluÅŸturmak daha saÄŸlÄ±klÄ± ama CSS yeterli gÃ¶rsel iÃ§in
        }
    });

    lns.forEach(l => {
        if(l.leafletPoly) l.leafletPoly.setStyle({ color: lColor, weight: parseInt(lWidth) });
    });
}

function updateConnectedLines(pointObj) {
    // Bu noktayÄ± kullanan tÃ¼m hatlarÄ± bul ve koordinatlarÄ±nÄ± yenile
    lns.forEach(l => {
        if (l.from === pointObj || l.to === pointObj) {
            if(l.leafletPoly) {
                l.leafletPoly.setLatLngs([[l.from.y, l.from.x], [l.to.y, l.to.x]]);
            }
        }
    });
}

function updatePtFromTable(idx, axis, val) {
    const v = parseFloat(val);
    if(axis === 'y') pts[idx].y = v;
    if(axis === 'x') pts[idx].x = v;
    
    // Haritadaki marker'Ä± taÅŸÄ±
    if(pts[idx].leafletMarker) {
        pts[idx].leafletMarker.setLatLng([pts[idx].y, pts[idx].x]);
    }
    // HatlarÄ± gÃ¼ncelle
    updateConnectedLines(pts[idx]);
}

// --- OTOMATÄ°K HAT ALGORÄ°TMALARI ---
function autoLink(type) {
    if(pts.length < 2) return alert("En az 2 nokta gerekli!");
    lns = []; // Eski hatlarÄ± temizle

    if(type === 'seq') {
        for(let i=0; i < pts.length - 1; i++) {
            lns.push({ from: pts[i], to: pts[i+1] });
        }
        alert("Noktalar liste sÄ±rasÄ±na gÃ¶re baÄŸlandÄ±.");
    } 
    else if(type === 'near') {
        const minStr = prompt("Minimum hat uzunluÄŸu (metre)?", "0.1");
        const maxStr = prompt("Maksimum hat uzunluÄŸu (metre)?", "50");
        
        if(minStr === null || maxStr === null) return;
        
        const minDist = parseFloat(minStr);
        const maxDist = parseFloat(maxStr);

        let unvisited = [...pts];
        let current = unvisited.shift();

        while(unvisited.length > 0) {
            let nearestIdx = -1;
            let currentMinDist = Infinity;

            // En yakÄ±nÄ±nÄ± bul
            unvisited.forEach((p, idx) => {
                const d = Math.sqrt(Math.pow(current.x - p.x, 2) + Math.pow(current.y - p.y, 2));
                if(d < currentMinDist) { currentMinDist = d; nearestIdx = idx; }
            });

            if(nearestIdx !== -1) {
                // Mesafe kontrolÃ¼ (MÄ°N ve MAX aralÄ±ÄŸÄ±nda mÄ±?)
                if(currentMinDist >= minDist && currentMinDist <= maxDist) {
                    const next = unvisited[nearestIdx];
                    lns.push({ from: current, to: next });
                    unvisited.splice(nearestIdx, 1);
                    current = next;
                } else {
                    // Kriter dÄ±ÅŸÄ± ise zinciri kopar, o noktaya atla ama Ã§izgi Ã§ekme
                    const next = unvisited.splice(nearestIdx, 1)[0];
                    current = next; 
                }
            } else {
                break;
            }
        }
        alert(`Min: ${minDist}m - Max: ${maxDist}m aralÄ±ÄŸÄ±ndaki en yakÄ±nlar baÄŸlandÄ±.`);
    }
    render();
}

// --- STANDART Ä°ÅLEMLER ---
function setMode(m) {
    mode = (mode === m) ? 'idle' : m;
    lineStartPt = null;
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-active'));
    if(mode !== 'idle') document.getElementById('btn-'+m)?.classList.add('btn-active');
}

function onMapClick(e) {
    if(mode === 'add') {
        pts.push({ id: "P" + (pts.length + 1), y: e.latlng.lat, x: e.latlng.lng, z: 0 });
        render();
        highlightRow(pts.length - 1);
    }
}

function handleLineClick(p) {
    if(!lineStartPt) {
        lineStartPt = p;
        alert(`${p.id} seÃ§ildi. Hedef noktayÄ± seÃ§in.`);
    } else {
        if(lineStartPt !== p) lns.push({ from: lineStartPt, to: p });
        lineStartPt = null;
        render();
    }
}

function deletePoint(index) {
    if(confirm("Nokta silinsin mi?")) {
        const pt = pts[index];
        lns = lns.filter(l => l.from !== pt && l.to !== pt);
        pts.splice(index, 1);
        render();
    }
}

function highlightRow(idx) {
    document.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected-row'));
    const row = document.getElementById(`row-${idx}`);
    if(row) { row.classList.add('selected-row'); row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
}

function zoomAll() {
    if(pts.length) map.fitBounds(L.featureGroup(pts.map(p=>L.marker([p.y,p.x]))).getBounds().pad(0.1));
}

// --- DOSYA YÃ–NETÄ°MÄ° ---
function loadFile(input) {
    const file = input.files[0];
    if(!file) return;
    const ext = file.name.split('.').pop().toLowerCase();
    const reader = new FileReader();

    reader.onload = (e) => {
        const content = e.target.result;
        pts = []; lns = []; // SÄ±fÄ±rla

        if (ext === 'ncn' || ext === 'xyz' || ext === 'txt') {
            parseTextData(content);
        } else if (ext === 'csv') {
            parseCSV(content);
        } else if (ext === 'kml') {
            parseKML(content);
        } else if (ext === 'geojson' || ext === 'json') {
            parseGeoJSON(content);
        }
        
        render(); zoomAll();
        input.value = ''; // Reset input
    };

    if(ext === 'xls' || ext === 'xlsx') {
        alert("Excel import iÃ§in lÃ¼tfen Ã¶nce CSV veya Metin (TXT/NCN) formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼n.");
        input.value = '';
    } else {
        reader.readAsText(file, "UTF-8"); // Genel UTF-8, NCN iÃ§in gerekirse windows-1254
    }
}

function parseTextData(data) {
    // NCN veya XYZ boÅŸluklu format
    data.split('\n').forEach(line => {
        // VirgÃ¼lleri noktaya Ã§evir, birden fazla boÅŸluÄŸu tek boÅŸluÄŸa indir
        let d = line.trim().replace(/,/g, '.').split(/\s+/);
        if(d.length >= 3) {
            let id = d[0];
            let y = parseFloat(d[1]);
            let x = parseFloat(d[2]);
            let z = parseFloat(d[3] || 0);
            
            // EÄŸer ilk kolon sayÄ± deÄŸilse ID'dir, yoksa XYZ formatÄ±dÄ±r
            if(isNaN(parseFloat(id)) || d.length > 3) {
                 // Standart NCN: ID Y X Z
            } else {
                 // Sadece koordinat olabilir: Y X Z
                 id = "P" + (pts.length + 1);
                 y = parseFloat(d[0]); x = parseFloat(d[1]); z = parseFloat(d[2]||0);
            }

            if(!isNaN(y) && !isNaN(x)) pts.push({ id: id, y: y, x: x, z: z });
        }
    });
}

function parseCSV(data) {
    const lines = data.split('\n');
    lines.forEach((line, i) => {
        if(i===0 && line.toLowerCase().includes('y')) return; // Header atla
        const d = line.trim().split(','); // CSV virgÃ¼l ayracÄ±
        if(d.length >= 2) {
            pts.push({
                id: d[0] || "P"+(pts.length+1),
                y: parseFloat(d[1]),
                x: parseFloat(d[2]),
                z: parseFloat(d[3]||0)
            });
        }
    });
}

function parseKML(xmlStr) {
    const parser = new DOMParser();
    const xml = parser.parseFromString(xmlStr, "text/xml");
    const placemarks = xml.getElementsByTagName("Placemark");
    
    for(let pm of placemarks) {
        const name = pm.getElementsByTagName("name")[0]?.textContent || "P"+(pts.length+1);
        const coords = pm.getElementsByTagName("coordinates")[0]?.textContent.trim();
        if(coords) {
            const c = coords.split(',');
            // KML: Lon(X), Lat(Y), Z
            pts.push({ id: name, x: parseFloat(c[0]), y: parseFloat(c[1]), z: parseFloat(c[2]||0) });
        }
    }
}

function parseGeoJSON(jsonStr) {
    try {
        const geo = JSON.parse(jsonStr);
        const features = geo.features || (geo.type === 'Feature' ? [geo] : []);
        features.forEach(f => {
            if(f.geometry && f.geometry.type === 'Point') {
                const c = f.geometry.coordinates;
                // GeoJSON: [Lon, Lat, Elev] -> [X, Y, Z]
                pts.push({
                    id: f.properties?.name || f.properties?.id || "P"+(pts.length+1),
                    x: c[0], y: c[1], z: c[2] || 0
                });
            }
        });
    } catch(e) { alert("GeoJSON hatasÄ±"); }
}

function exportData(type) {
    if(!pts.length) return alert("Veri yok!");
    
    let content = "";
    let filename = "Proje." + type;
    let mime = "text/plain";

    if(type === 'xls') {
        const ws = XLSX.utils.json_to_sheet(pts.map(p => ({"No":p.id, "Y":p.y, "X":p.x, "Z":p.z})));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Noktalar");
        XLSX.writeFile(wb, "Proje.xlsx");
        return;
    } 
    else if (type === 'ncn') {
        content = pts.map(p => `${p.id}\t${p.y.toFixed(3)}\t${p.x.toFixed(3)}\t${p.z.toFixed(3)}`).join("\r\n");
    } 
    else if (type === 'xyz') {
        content = pts.map(p => `${p.y.toFixed(3)} ${p.x.toFixed(3)} ${p.z.toFixed(3)}`).join("\r\n");
    }
    else if (type === 'csv') {
        content = "ID,Y,X,Z\n" + pts.map(p => `${p.id},${p.y},${p.x},${p.z}`).join("\n");
        mime = "text/csv";
    }
    else if (type === 'dxf') {
        content = "0\nSECTION\n2\nENTITIES\n";
        pts.forEach(p => content += `0\nPOINT\n8\nNOKTA\n10\n${p.x}\n20\n${p.y}\n30\n${p.z}\n`);
        lns.forEach(l => content += `0\nLINE\n8\nHAT\n10\n${l.from.x}\n20\n${l.from.y}\n11\n${l.to.x}\n21\n${l.to.y}\n`);
        content += "0\nENDSEC\n0\nEOF";
    }
    else if (type === 'kml') {
        content = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
  <Document>
    ${pts.map(p => `
    <Placemark>
      <name>${p.id}</name>
      <Point><coordinates>${p.x},${p.y},${p.z}</coordinates></Point>
    </Placemark>`).join('')}
    ${lns.map(l => `
    <Placemark>
      <LineString><coordinates>${l.from.x},${l.from.y},0 ${l.to.x},${l.to.y},0</coordinates></LineString>
    </Placemark>`).join('')}
  </Document>
</kml>`;
        mime = "application/vnd.google-earth.kml+xml";
    }
    else if (type === 'geojson') {
        const fc = {
            type: "FeatureCollection",
            features: pts.map(p => ({
                type: "Feature",
                properties: { name: p.id, z: p.z },
                geometry: { type: "Point", coordinates: [p.x, p.y, p.z] }
            })).concat(lns.map(l => ({
                type: "Feature",
                properties: { type: "line" },
                geometry: { type: "LineString", coordinates: [[l.from.x, l.from.y], [l.to.x, l.to.y]] }
            })))
        };
        content = JSON.stringify(fc);
        mime = "application/json";
    }

    download(content, filename, mime);
}

function download(content, filename, mimeType) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type: mimeType || 'text/plain'}));
    a.download = filename;
    a.click();
}

init();
</script>
</body>
</html>

