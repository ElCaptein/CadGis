<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>CAD Pro v102 - Ultimate Surveyor</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --brand: #e67e22; --dark: #2c3e50; --bg: #ecf0f1; --highlight: #f1c40f; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #333; overflow: hidden; }
        
        #map { flex-grow: 1; cursor: crosshair; background: #1a1a1a; }
        
        /* Sol Panel */
        .sidebar { position: absolute; top: 10px; left: 10px; width: 340px; background: rgba(255,255,255,0.98); padding: 10px; border-radius: 8px; z-index: 2000; box-shadow: 0 4px 15px rgba(0,0,0,0.6); max-height: 90vh; overflow-y: auto; border-left: 5px solid var(--brand); }
        .section-title { font-size: 11px; font-weight: 800; color: #7f8c8d; border-bottom: 2px solid #ecf0f1; margin: 10px 0 5px 0; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .btn { width: 100%; padding: 7px; margin: 3px 0; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 600; font-size: 11px; transition: 0.2s; background: #34495e; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .btn-active { background: var(--brand) !important; box-shadow: inset 0 0 0 2px white; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        
        /* Stil Kontrolleri */
        .style-control { display: flex; align-items: center; justify-content: space-between; font-size: 11px; margin-bottom: 4px; }
        input[type=range] { width: 60px; }
        input[type=color] { border: none; width: 25px; height: 20px; cursor: pointer; padding: 0; }
        
        /* Alt Tablo */
        #table-wrapper { height: 25vh; background: white; z-index: 2000; overflow: auto; border-top: 4px solid var(--dark); position: relative; }
        table { width: 100%; border-collapse: collapse; font-size: 11px; font-family: 'Consolas', monospace; }
        th { position: sticky; top: 0; background: #bdc3c7; padding: 6px; z-index: 10; border-bottom: 2px solid #7f8c8d; }
        td { padding: 4px; border-bottom: 1px solid #eee; text-align: center; }
        .selected-row { background-color: var(--highlight) !important; font-weight: bold; }
        input.coord-inp { width: 90%; text-align: center; border: 1px solid #ddd; padding: 2px; border-radius: 3px; }

        /* AnlÄ±k Delta Kutusu */
        #delta-box { position: absolute; bottom: 26vh; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; z-index: 3000; display: none; border: 1px solid var(--highlight); pointer-events: none; }
        
        .cad-label { font-weight: bold; color: #fff; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000; font-size: 11px; background: none; border: none; box-shadow: none; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="delta-box">Î”Y: 0.00 | Î”X: 0.00</div>

<div class="sidebar">
    <div class="section-title">ğŸ¨ STÄ°L VE GÃ–RÃœNÃœM</div>
    <div class="style-control">
        <span>Nokta Boyutu:</span>
        <input type="range" id="ptSize" min="4" max="20" value="8" oninput="render()">
        <input type="color" id="ptColor" value="#3498db" onchange="render()">
    </div>
    <div class="style-control">
        <span>Hat KalÄ±nlÄ±ÄŸÄ±:</span>
        <input type="range" id="lnWidth" min="1" max="10" value="2" oninput="render()">
        <input type="color" id="lnColor" value="#2ecc71" onchange="render()">
    </div>
    <div class="style-control">
        <span>Etiket:</span>
        <select id="labelMode" onchange="render()" style="font-size:10px; padding:2px;">
            <option value="id">Nokta No</option>
            <option value="z">Kot (Z)</option>
            <option value="both">No + Kot</option>
            <option value="none">Yok</option>
        </select>
    </div>

    <div class="section-title">ğŸ”— OTOMATÄ°K HAT Ã‡Ä°ZÄ°MÄ°</div>
    <div class="btn-row">
        <button class="btn" style="background:#8e44ad" onclick="autoLink('seq')">ğŸ”„ SIRALI (NCN)</button>
        <button class="btn" style="background:#d35400" onclick="autoLink('near')">ğŸ“ EN YAKIN</button>
    </div>

    <div class="section-title">ğŸ› ï¸ Ã‡Ä°ZÄ°M ARAÃ‡LARI</div>
    <div class="btn-row">
        <button id="btn-add" class="btn" onclick="setMode('add')">â• NOKTA</button>
        <button id="btn-line" class="btn" onclick="setMode('line')">ğŸ“ HAT Ã‡Ä°Z</button>
    </div>
    <div class="btn-row">
        <button id="btn-delPt" class="btn btn-red" style="background:#c0392b" onclick="setMode('delPt')">âœ– NOKTA SÄ°L</button>
        <button id="btn-delLine" class="btn btn-red" style="background:#c0392b" onclick="setMode('delLine')">âœ‚ HAT SÄ°L</button>
    </div>

    <div class="section-title">ğŸ“‚ DOSYA</div>
    <div class="btn-row">
        <button class="btn" style="background:#2980b9" onclick="document.getElementById('fileIn').click()">ğŸ“¥ YÃœKLE</button>
        <input type="file" id="fileIn" hidden onchange="loadFile(this)">
        <button class="btn" style="background:#27ae60" onclick="exportData('xls')">ğŸ“¤ EXCEL</button>
    </div>
    <div class="btn-row">
        <button class="btn" style="background:#34495e" onclick="exportData('dxf')">ğŸ“¤ DXF</button>
        <button class="btn" style="background:#34495e" onclick="exportData('ncn')">ğŸ“¤ NCN</button>
    </div>
    
    <button class="btn" style="background:#000; margin-top:5px;" onclick="zoomAll()">ğŸ¯ EKRANA SIÄDIR</button>
</div>

<div id="table-wrapper">
    <table id="coordTable">
        <thead>
            <tr><th>NO</th><th>Y (DOÄU)</th><th>X (KUZEY)</th><th>Z</th><th>Ä°ÅLEM</th></tr>
        </thead>
        <tbody id="tBody"></tbody>
    </table>
</div>

<script>
// --- GLOBAL DEÄÄ°ÅKENLER ---
let pts = []; // {id, y, x, z}
let lns = []; // {from, to} (Obje referanslarÄ±)
let map, lyrPts, lyrLns;
let mode = 'idle';
let lineStartPt = null;
let dragStartPos = null;

// --- BAÅLATMA ---
function init() {
    map = L.map('map', { crs: L.CRS.Simple, minZoom: -5, zoomControl: false });
    lyrLns = L.layerGroup().addTo(map);
    lyrPts = L.layerGroup().addTo(map);
    map.setView([0, 0], 0);

    map.on('click', onMapClick);
    document.addEventListener('keydown', (e) => {
        if(e.key === "Escape") { setMode('idle'); alert("Mod Ä°ptal Edildi."); }
    });
}

// --- RENDER MOTORU (Stil AyarlarÄ±yla) ---
function render() {
    lyrPts.clearLayers();
    lyrLns.clearLayers();
    const tBody = document.getElementById('tBody');
    tBody.innerHTML = '';
    
    // Stil AyarlarÄ±nÄ± Oku
    const pSize = document.getElementById('ptSize').value;
    const pColor = document.getElementById('ptColor').value;
    const lWidth = document.getElementById('lnWidth').value;
    const lColor = document.getElementById('lnColor').value;
    const lblMode = document.getElementById('labelMode').value;

    // 1. HatlarÄ± Ã‡iz
    lns.forEach((lineObj, idx) => {
        const poly = L.polyline(
            [[lineObj.from.y, lineObj.from.x], [lineObj.to.y, lineObj.to.x]], 
            { color: lColor, weight: parseInt(lWidth), opacity: 0.8 }
        ).addTo(lyrLns);
        
        poly.on('click', (e) => {
            if (mode === 'delLine') {
                L.DomEvent.stopPropagation(e);
                if(confirm("Hat silinsin mi?")) { lns.splice(idx, 1); render(); }
            }
        });
    });

    // 2. NoktalarÄ± Ã‡iz
    pts.forEach((p, i) => {
        // Dinamik CSS ile Marker oluÅŸtur
        const iconHtml = `<div style="
            width:${pSize}px; height:${pSize}px; 
            background:${pColor}; 
            border:2px solid white; 
            border-radius:50%; 
            box-shadow:0 0 5px rgba(0,0,0,0.5);"></div>`;

        const marker = L.marker([p.y, p.x], {
            draggable: true,
            icon: L.divIcon({
                className: 'custom-pt',
                html: iconHtml,
                iconSize: [pSize, pSize],
                iconAnchor: [pSize/2, pSize/2] // Merkezi ortala
            })
        }).addTo(lyrPts);

        // Etiketleme
        let lblText = "";
        if(lblMode === 'id') lblText = p.id;
        else if(lblMode === 'z') lblText = p.z;
        else if(lblMode === 'both') lblText = `${p.id}\n${p.z}`;
        
        if(lblMode !== 'none') {
            marker.bindTooltip(String(lblText), { 
                permanent: true, direction: "top", className: "cad-label", offset: [0, -pSize/2] 
            });
        }

        // SÃ¼rÃ¼kleme MantÄ±ÄŸÄ± (CanlÄ± GÃ¼ncelleme)
        marker.on('dragstart', (e) => {
            dragStartPos = e.target.getLatLng();
            document.getElementById('delta-box').style.display = 'block';
            highlightRow(i);
        });

        marker.on('drag', (e) => {
            const curr = e.target.getLatLng();
            const dY = (curr.lat - dragStartPos.lat) * 100; // cm
            const dX = (curr.lng - dragStartPos.lng) * 100; // cm
            document.getElementById('delta-box').innerHTML = `<b>${p.id}</b> Î”Y:${dY.toFixed(1)}cm | Î”X:${dX.toFixed(1)}cm`;
            document.getElementById(`iy-${i}`).value = curr.lat.toFixed(3);
            document.getElementById(`ix-${i}`).value = curr.lng.toFixed(3);
        });

        marker.on('dragend', (e) => {
            document.getElementById('delta-box').style.display = 'none';
            const finalPos = e.target.getLatLng();
            if(confirm(`${p.id} yeri deÄŸiÅŸsin mi?`)) {
                pts[i].y = finalPos.lat;
                pts[i].x = finalPos.lng;
                render();
            } else {
                render(); // Eski yerine dÃ¶ner
            }
        });

        marker.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if (mode === 'delPt') { deletePoint(i); return; }
            if (mode === 'line') { handleLineClick(p); return; }
            highlightRow(i);
        });

        // Tablo SatÄ±rÄ±
        const tr = document.createElement('tr');
        tr.id = `row-${i}`;
        tr.innerHTML = `
            <td><input class="coord-inp" value="${p.id}" onchange="pts[${i}].id=this.value;render()"></td>
            <td><input id="iy-${i}" class="coord-inp" type="number" step="0.01" value="${p.y.toFixed(3)}" onchange="pts[${i}].y=parseFloat(this.value);render()"></td>
            <td><input id="ix-${i}" class="coord-inp" type="number" step="0.01" value="${p.x.toFixed(3)}" onchange="pts[${i}].x=parseFloat(this.value);render()"></td>
            <td><input class="coord-inp" type="number" step="0.01" value="${p.z}" onchange="pts[${i}].z=parseFloat(this.value);render()"></td>
            <td><button onclick="deletePoint(${i})" style="color:red;border:none;background:none;cursor:pointer;">ğŸ—‘ï¸</button></td>
        `;
        tBody.appendChild(tr);
    });
}

// --- OTOMATÄ°K HAT ALGORÄ°TMALARI ---
function autoLink(type) {
    if(pts.length < 2) return alert("En az 2 nokta gerekli!");
    lns = []; // Eski hatlarÄ± temizle

    if(type === 'seq') {
        // NCN SÄ±ralÄ± (P1->P2, P2->P3...)
        // Listede arka arkaya gelenleri baÄŸlar
        for(let i=0; i < pts.length - 1; i++) {
            lns.push({ from: pts[i], to: pts[i+1] });
        }
        alert("Noktalar liste sÄ±rasÄ±na gÃ¶re baÄŸlandÄ±.");
    } 
    else if(type === 'near') {
        // En YakÄ±n + Maks Mesafe KontrolÃ¼
        const maxDistStr = prompt("Maksimum hat mesafesi kaÃ§ metre olsun?", "50");
        if(!maxDistStr) return;
        const maxDist = parseFloat(maxDistStr);

        let unvisited = [...pts];
        let current = unvisited.shift(); // Ä°lk noktadan baÅŸla

        while(unvisited.length > 0) {
            let nearestIdx = -1;
            let minDist = Infinity;

            // En yakÄ±nÄ±nÄ± bul
            unvisited.forEach((p, idx) => {
                const d = Math.sqrt(Math.pow(current.x - p.x, 2) + Math.pow(current.y - p.y, 2));
                if(d < minDist) { minDist = d; nearestIdx = idx; }
            });

            if(nearestIdx !== -1) {
                // EÄŸer mesafe limit dahilindeyse baÄŸla
                if(minDist <= maxDist) {
                    const next = unvisited[nearestIdx];
                    lns.push({ from: current, to: next });
                    // BulduÄŸumuz noktaya git
                    unvisited.splice(nearestIdx, 1);
                    current = next;
                } else {
                    // Mesafe Ã§ok uzak, hat Ã§izme ama sÄ±Ã§rama yap (zinciri kopar)
                    // Bir sonraki en yakÄ±n noktadan Ã§izime devam et ama arada Ã§izgi olmasÄ±n
                    const next = unvisited.splice(nearestIdx, 1)[0];
                    current = next; 
                }
            } else {
                break;
            }
        }
        alert(`Maksimum ${maxDist}m mesafedeki en yakÄ±n noktalar baÄŸlandÄ±.`);
    }
    render();
}

// --- STANDART Ä°ÅLEMLER ---
function setMode(m) {
    mode = (mode === m) ? 'idle' : m;
    lineStartPt = null;
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-active'));
    if(mode !== 'idle') document.getElementById('btn-'+m)?.classList.add('btn-active');
}

function onMapClick(e) {
    if(mode === 'add') {
        pts.push({ id: "P" + (pts.length + 1), y: e.latlng.lat, x: e.latlng.lng, z: 0 });
        render();
        highlightRow(pts.length - 1);
    }
}

function handleLineClick(p) {
    if(!lineStartPt) {
        lineStartPt = p;
        alert(`${p.id} seÃ§ildi. Hedef noktayÄ± seÃ§in.`);
    } else {
        if(lineStartPt !== p) lns.push({ from: lineStartPt, to: p });
        lineStartPt = null;
        render();
    }
}

function deletePoint(index) {
    if(confirm("Nokta silinsin mi?")) {
        const pt = pts[index];
        lns = lns.filter(l => l.from !== pt && l.to !== pt); // BaÄŸlÄ± hatlarÄ± temizle
        pts.splice(index, 1);
        render();
    }
}

function highlightRow(idx) {
    document.querySelectorAll('tr').forEach(tr => tr.classList.remove('selected-row'));
    const row = document.getElementById(`row-${idx}`);
    if(row) { row.classList.add('selected-row'); row.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
}

function zoomAll() {
    if(pts.length) map.fitBounds(L.featureGroup(pts.map(p=>L.marker([p.y,p.x]))).getBounds().pad(0.1));
}

// --- DOSYA & EXPORT ---
function loadFile(input) {
    const file = input.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        if(file.name.toLowerCase().includes('.ncn')) parseNCN(e.target.result);
        render(); zoomAll();
    };
    reader.readAsText(file, "windows-1254");
}

function parseNCN(data) {
    pts = []; lns = [];
    data.split('\n').forEach(line => {
        const d = line.trim().split(/\s+/);
        if(d.length >= 3) {
            const y = parseFloat(d[1].replace(',','.'));
            const x = parseFloat(d[2].replace(',','.'));
            if(!isNaN(y)) pts.push({ id: d[0], y: y, x: x, z: parseFloat(d[3]||0) });
        }
    });
}

function exportData(type) {
    if(!pts.length) return alert("Veri yok!");
    if(type === 'xls') {
        const ws = XLSX.utils.json_to_sheet(pts.map(p => ({"No":p.id, "Y":p.y, "X":p.x, "Z":p.z})));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Noktalar");
        XLSX.writeFile(wb, "Proje.xlsx");
    } else if (type === 'ncn') {
        const txt = pts.map(p => `${p.id}\t${p.y.toFixed(3)}\t${p.x.toFixed(3)}\t${p.z.toFixed(3)}`).join("\r\n");
        download(txt, "Proje.ncn");
    } else if (type === 'dxf') {
        let txt = "0\nSECTION\n2\nENTITIES\n";
        pts.forEach(p => txt += `0\nPOINT\n8\nNOKTA\n10\n${p.x}\n20\n${p.y}\n30\n${p.z}\n`);
        lns.forEach(l => txt += `0\nLINE\n8\nHAT\n10\n${l.from.x}\n20\n${l.from.y}\n11\n${l.to.x}\n21\n${l.to.y}\n`);
        txt += "0\nENDSEC\n0\nEOF";
        download(txt, "Proje.dxf");
    }
}

function download(content, filename) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], {type: 'text/plain'}));
    a.download = filename;
    a.click();
}

init();
</script>
</body>
</html>
