<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Mobile CAD Pro v2.2 - Boykesit Modu</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --brand: #e67e22; --dark: #2c3e50; --danger: #c0392b; --success: #27ae60; --info: #2980b9; --measure: #f1c40f; --area: #9b59b6; --profile: #8e44ad; }
        body { margin: 0; display: flex; flex-direction: column; height: 100vh; font-family: 'Segoe UI', sans-serif; background: #333; overflow: hidden; }
        #map { flex-grow: 1; cursor: crosshair; background: #1a1a1a; }
        
        /* Sidebar */
        .sidebar { position: absolute; top: 10px; left: 10px; width: 370px; background: rgba(255,255,255,0.98); border-radius: 8px; z-index: 2000; box-shadow: 0 4px 25px rgba(0,0,0,0.6); max-height: 85vh; overflow-y: auto; display: flex; flex-direction: column; }
        
        .acc-item { border-bottom: 1px solid #ddd; }
        .acc-header { background: #f1f2f6; padding: 10px 15px; cursor: pointer; font-weight: 800; font-size: 11px; color: #2f3542; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }
        .acc-header:hover { background: #e2e6ea; }
        .acc-content { padding: 10px; display: none; background: #fff; }
        .acc-item.active .acc-content { display: block; }
        .acc-item.active .acc-header { border-left: 5px solid var(--brand); color: var(--brand); background: #fff; }

        .btn { width: 100%; padding: 8px; margin: 3px 0; border: none; border-radius: 4px; cursor: pointer; color: white; font-weight: 700; font-size: 10px; transition: 0.2s; background: #57606f; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .btn:hover { filter: brightness(1.15); }
        .btn-active { background: var(--brand) !important; outline: 2px solid #fff; box-shadow: inset 0 0 5px rgba(0,0,0,0.5); }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }

        label { font-size: 10px; font-weight: 800; color: #7f8c8d; display: block; margin-bottom: 2px; }
        select, input[type="range"] { width: 100%; margin-bottom: 8px; cursor: pointer; }
        
        /* Info Panel */
        #info-panel { position: absolute; bottom: 27vh; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.85); color: #00ff00; padding: 10px 20px; border-radius: 10px; font-family: monospace; font-size: 12px; z-index: 3000; display: none; border: 1px solid var(--brand); white-space: pre; text-align: center; }
        
        /* Table */
        #table-wrapper { height: 25vh; background: white; z-index: 2000; overflow: auto; border-top: 5px solid var(--dark); }
        table { width: 100%; border-collapse: collapse; font-size: 11px; table-layout: fixed; }
        th { position: sticky; top: 0; background: #ced4da; padding: 10px; z-index: 10; border-bottom: 2px solid #adb5bd; }
        td { padding: 6px; border-bottom: 1px solid #f1f2f6; text-align: center; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        tr.selected-row { background-color: #fff3e0 !important; font-weight: bold; border-left: 5px solid var(--brand); }
        
        .cad-label { background: transparent !important; border: none !important; color: #fff !important; font-weight: bold; text-shadow: 1px 1px 2px #000; pointer-events: none; text-align: center; margin-top: -5px; }
        .layer-row { display: flex; justify-content: space-between; align-items: center; padding: 4px; border-bottom: 1px solid #eee; font-size: 11px; }

        /* PROFILE MODAL */
        #profile-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 800px; background: white; z-index: 4000;
            box-shadow: 0 0 50px rgba(0,0,0,0.8); border-radius: 8px; padding: 15px;
            flex-direction: column;
        }
        #profile-chart-container { width: 100%; height: 300px; background: #f9f9f9; border: 1px solid #ddd; position: relative; margin-bottom: 10px; }
        canvas { display: block; width: 100%; height: 100%; }
        .modal-header { font-weight: bold; font-size: 14px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .close-btn { cursor: pointer; color: red; font-size: 18px; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="info-panel"></div>

<div id="profile-modal">
    <div class="modal-header">
        <span>ğŸ“‰ BOYKESÄ°T (PROFÄ°L) ANALÄ°ZÄ°</span>
        <span class="close-btn" onclick="closeProfile()">âœ–</span>
    </div>
    <div id="profile-chart-container">
        <canvas id="profileCanvas"></canvas>
    </div>
    <div class="grid-2">
        <button class="btn" style="background:#217346" onclick="exportProfileExcel()">ğŸ’¾ EXCEL OLARAK Ä°NDÄ°R</button>
        <button class="btn" style="background:#555" onclick="closeProfile()">KAPAT</button>
    </div>
</div>

<div class="sidebar">
    <div style="padding:10px; background:#fff; border-bottom:1px solid #eee;">
        <div class="grid-2">
            <button class="btn" style="background:#f39c12; color:#000;" onclick="undo()">â¬…ï¸ GERÄ° AL</button>
            <button class="btn" style="background:#000;" onclick="zoomAll()">ğŸ¯ SIÄDIR</button>
        </div>
    </div>

    <div class="acc-item active">
        <div class="acc-header" onclick="toggleAcc(this)">ğŸ“ HESAPLAMA & Ã‡Ä°ZÄ°M <span>â–¼</span></div>
        <div class="acc-content">
            <div class="grid-2">
                <button id="btn-measure" class="btn" style="background:var(--measure); color:#000;" onclick="setMode('measure')">ğŸ“ CETVEL (Mesafe)</button>
                <button id="btn-area" class="btn" style="background:var(--area);" onclick="setMode('area')">ğŸ“ ALAN HESABI</button>
            </div>
             <button id="btn-profile" class="btn" style="background:var(--profile);" onclick="setMode('profile')">ğŸ“‰ BOYKESÄ°T (PROFÄ°L)</button>
            <hr style="border:0; border-top:1px solid #eee; margin:5px 0;">
            <div class="grid-2">
                <button id="btn-add" class="btn" onclick="setMode('add')">â• NOKTA AT</button>
                <button id="btn-line" class="btn" onclick="setMode('line')">â– HAT Ã‡Ä°Z</button>
            </div>
            <div class="grid-2">
                <button id="btn-delPt" class="btn" style="background:var(--danger)" onclick="setMode('delPt')">âœ– SÄ°L (Nokta)</button>
                <button id="btn-delLn" class="btn" style="background:var(--danger)" onclick="setMode('delLn')">âœ‚ SÄ°L (Hat)</button>
            </div>
        </div>
    </div>

    <div class="acc-item">
        <div class="acc-header" onclick="toggleAcc(this)">ğŸ“‚ DOSYA & Ä°Ã‡E/DIÅA AKTAR <span>â–¼</span></div>
        <div class="acc-content">
            <button class="btn" style="background:var(--info)" onclick="document.getElementById('fileIn').click()">ğŸ“¥ DOSYA YÃœKLE (NCN/TXT)</button>
            <input type="file" id="fileIn" hidden onchange="loadFile(this)" accept=".ncn,.txt">
            <div style="margin-top:5px; font-size:9px; font-weight:bold; color:#777;">DIÅA AKTAR:</div>
            <div class="grid-3">
                <button class="btn" style="background:#217346" onclick="exportXLS()">XLS</button>
                <button class="btn" style="background:#e74c3c" onclick="exportDXF()">DXF</button>
                <button class="btn" style="background:#2980b9" onclick="exportNCN()">NCN</button>
                <button class="btn" style="background:#666" onclick="exportXYZ()">XYZ</button>
                <button class="btn" style="background:#3498db" onclick="exportKML()">KML</button>
                <button class="btn" style="background:#9b59b6" onclick="exportJSON()">JSON</button>
            </div>
        </div>
    </div>

    <div class="acc-item">
        <div class="acc-header" onclick="toggleAcc(this)">ğŸ”— OTOMATÄ°K BAÄLANTI <span>â–¼</span></div>
        <div class="acc-content">
            <button class="btn" style="background:#8e44ad" onclick="autoLink('layer')">ğŸ—ï¸ AYNI TABAKALARI BAÄLA (Min/Max)</button>
            <button class="btn" style="background:#d35400" onclick="autoLink('near')">ğŸ“ EN YAKINLARI BAÄLA (Min/Max)</button>
            <button class="btn" style="background:#1abc9c" onclick="autoLink('sequence')">ğŸ”„ 1-2-3 SIRA Ä°LE BAÄLA</button>
        </div>
    </div>

    <div class="acc-item">
        <div class="acc-header" onclick="toggleAcc(this)">ğŸ¨ GÃ–RÃœNÃœM & STÄ°L <span>â–¼</span></div>
        <div class="acc-content">
            <div class="grid-2">
                <div><label>Nokta Tipi</label><select id="ptType" onchange="render()"><option value="35">Daire+Ã‡arpÄ±</option><option value="3">ArtÄ± (+)</option><option value="4">Ã‡arpÄ± (x)</option><option value="0">Nokta</option></select></div>
                <div><label>Boyut</label><input type="range" id="ptSize" min="5" max="30" value="14" oninput="render()"></div>
            </div>
            <div class="grid-2">
                <div><label>Hat Tipi</label><select id="lineType" onchange="render()"><option value="solid">DÃ¼z</option><option value="dash">Kesik</option><option value="dot">NoktalÄ±</option><option value="dashdot">Kesik-Nokta</option></select></div>
                <div><label>KalÄ±nlÄ±k</label><input type="range" id="lineWidth" min="1" max="10" value="2" oninput="render()"></div>
            </div>
            <label>Etiketler</label>
            <select id="labelMode" onchange="render()">
                <option value="id">Nokta No</option>
                <option value="z">Kot (Z)</option>
                <option value="id_z">No + Kot</option>
                <option value="none">Gizle</option>
            </select>
        </div>
    </div>

     <div class="acc-item">
        <div class="acc-header" onclick="toggleAcc(this)">ğŸ—ï¸ TABAKA YÃ–NETÄ°MÄ° <span>â–¼</span></div>
        <div class="acc-content">
            <div id="layer-container" style="max-height:120px; overflow-y:auto;"></div>
        </div>
    </div>
</div>

<div id="table-wrapper">
    <table>
        <thead><tr><th>NO</th><th>Y (DOÄU/SAÄ)</th><th>X (KUZEY/YUKARI)</th><th>Z</th><th>TABAKA</th></tr></thead>
        <tbody id="tBody"></tbody>
    </table>
</div>

<script>
let pts = []; let lns = []; let history = []; 
let map, lyrPts, lyrLns, lyrTemp;
let mode = 'idle'; let lineStart = null; 
let measurePts = []; let areaPts = []; let profilePts = []; // Profil noktalarÄ± eklendi
let profileData = []; // Profil hesap verileri
const hiddenLayers = new Set(); const layerColors = {};

function init() {
    map = L.map('map', { crs: L.CRS.Simple, minZoom: -5, zoomControl: false });
    lyrLns = L.layerGroup().addTo(map); 
    lyrPts = L.layerGroup().addTo(map); 
    lyrTemp = L.layerGroup().addTo(map);
    map.setView([0, 0], 2);
    
    map.on('click', (e) => { 
        if(mode === 'add') { saveState(); addPoint(e.latlng.lat, e.latlng.lng); }
        else if(mode === 'measure') addMeasurePt(e.latlng);
        else if(mode === 'area') addAreaPt(e.latlng);
    });
    
    // SaÄŸ tÄ±k ile Ã¶lÃ§Ã¼m/alan/profil bitirme
    map.on('contextmenu', (e) => {
        if(mode === 'measure' || mode === 'area') {
            resetMode();
        } else if (mode === 'profile') {
            finishProfile();
        }
    });
}

function render() {
    lyrPts.clearLayers(); lyrLns.clearLayers(); 
    if(mode !== 'measure' && mode !== 'area' && mode !== 'profile') lyrTemp.clearLayers();
    
    const tBody = document.getElementById('tBody'); tBody.innerHTML = '';
    const pType = document.getElementById('ptType').value;
    const pSize = parseInt(document.getElementById('ptSize').value);
    const lType = document.getElementById('lineType').value;
    const lWidth = parseInt(document.getElementById('lineWidth').value);
    const lblM = document.getElementById('labelMode').value;

    let dashArr = null;
    if(lType === 'dash') dashArr = "10, 10"; else if(lType === 'dot') dashArr = "2, 8"; else if(lType === 'dashdot') dashArr = "15, 10, 2, 10";

    lns.forEach((l, idx) => {
        if(hiddenLayers.has(l.layer)) return;
        const poly = L.polyline([[l.from.y, l.from.x], [l.to.y, l.to.x]], { color: l.color, weight: lWidth, dashArray: dashArr }).addTo(lyrLns);
        poly.on('click', (e) => { if(mode === 'delLn') { L.DomEvent.stopPropagation(e); saveState(); lns.splice(idx, 1); render(); } });
    });

    pts.forEach((p, i) => {
        if(hiddenLayers.has(p.layer)) return;
        
        let htmlSym;
        const col = p.color; const half = pSize/2;
        if(pType === '35') htmlSym = `<div style="width:${pSize}px; height:${pSize}px; border:2px solid ${col}; border-radius:50%; display:flex; align-items:center; justify-content:center; color:${col}; font-weight:bold; font-size:${pSize-4}px;">Ã—</div>`;
        else if(pType === '3') htmlSym = `<div style="font-size:${pSize+4}px; color:${col}; font-weight:bold; line-height:${pSize}px;">+</div>`;
        else if(pType === '4') htmlSym = `<div style="font-size:${pSize+2}px; color:${col}; font-weight:bold; line-height:${pSize}px;">Ã—</div>`;
        else htmlSym = `<div style="width:${half}px; height:${half}px; background:${col}; border:1px solid #fff; border-radius:50%;"></div>`;

        const marker = L.marker([p.y, p.x], {
            draggable: true,
            icon: L.divIcon({ html: htmlSym, className: '', iconSize: [pSize, pSize], iconAnchor: [pSize/2, pSize/2] })
        }).addTo(lyrPts);

        if(lblM !== 'none') {
            let txt = lblM==='id' ? p.id : lblM==='z' ? p.z.toFixed(2) : `${p.id}\n${p.z.toFixed(2)}`;
            marker.bindTooltip(txt, { permanent: true, direction: "top", className: "cad-label", offset: [0, -half] });
        }

        marker.on('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if(mode === 'line') handleLine(p);
            else if(mode === 'measure') addMeasurePt({lat:p.y, lng:p.x});
            else if(mode === 'area') addAreaPt({lat:p.y, lng:p.x});
            else if(mode === 'profile') addToProfile(p);
            else if(mode === 'delPt') { saveState(); pts.splice(i,1); cleanupLines(); render(); }
            else highlightRow(i, true);
        });

        marker.on('drag', (e) => {
            const c = e.target.getLatLng(); p.y=c.lat; p.x=c.lng;
            document.getElementById('row-'+i).cells[1].innerText = p.y.toFixed(3);
            document.getElementById('row-'+i).cells[2].innerText = p.x.toFixed(3);
            lns.forEach(l => { if(l.from===p || l.to===p) render(); });
        });

        const tr = document.createElement('tr'); tr.id = `row-${i}`;
        tr.innerHTML = `<td><b>${p.id}</b></td><td>${p.y.toFixed(3)}</td><td>${p.x.toFixed(3)}</td><td>${p.z.toFixed(2)}</td><td style="color:${p.color}">${p.layer}</td>`;
        tr.onclick = () => { highlightRow(i, false); map.flyTo([p.y, p.x], map.getZoom()); };
        tBody.appendChild(tr);
    });
    updateLayerList();
}

// --- BOYKESÄ°T / PROFÄ°L MODÃœLÃœ ---
function addToProfile(p) {
    // AynÄ± nokta Ã¼st Ã¼ste eklenmesin
    if(profilePts.length > 0 && profilePts[profilePts.length-1] === p) return;
    
    profilePts.push(p);
    
    // GeÃ§ici Ã‡izgi
    lyrTemp.clearLayers();
    if(profilePts.length > 1) {
        const coords = profilePts.map(pt => [pt.y, pt.x]);
        L.polyline(coords, {color: '#8e44ad', weight: 4}).addTo(lyrTemp);
    }
    profilePts.forEach(pt => {
        L.circleMarker([pt.y, pt.x], {radius: 5, color: '#8e44ad', fillColor: '#fff', fillOpacity:1}).addTo(lyrTemp);
    });

    showInfo(`ğŸ“‰ BOYKESÄ°T: ${profilePts.length} nokta seÃ§ildi.\nBitirmek iÃ§in SaÄŸ TÄ±k...`);
}

function finishProfile() {
    if(profilePts.length < 2) { alert("Boykesit iÃ§in en az 2 nokta seÃ§melisiniz."); return; }
    
    // HESAPLAMA
    let totalDist = 0;
    profileData = [];
    
    profilePts.forEach((p, i) => {
        let dist = 0;
        if(i > 0) {
            dist = Math.sqrt(Math.pow(p.x - profilePts[i-1].x, 2) + Math.pow(p.y - profilePts[i-1].y, 2));
            totalDist += dist;
        }
        profileData.push({
            no: p.id,
            distPartial: dist,
            distCum: totalDist,
            z: p.z
        });
    });

    drawProfileChart();
    document.getElementById('profile-modal').style.display = 'flex';
    resetMode();
}

function drawProfileChart() {
    const canvas = document.getElementById('profileCanvas');
    const ctx = canvas.getContext('2d');
    const w = canvas.parentElement.offsetWidth;
    const h = canvas.parentElement.offsetHeight;
    canvas.width = w; canvas.height = h;

    // Min/Max bul
    const maxDist = profileData[profileData.length-1].distCum;
    let minZ = Infinity, maxZ = -Infinity;
    profileData.forEach(d => { if(d.z < minZ) minZ=d.z; if(d.z > maxZ) maxZ=d.z; });
    
    if(maxZ === minZ) { maxZ += 1; minZ -= 1; } // DÃ¼z Ã§izgi hatasÄ± Ã¶nleme
    const rangeZ = maxZ - minZ;
    const padding = 40;
    
    // Temizle
    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#fff'; ctx.fillRect(0,0,w,h);
    
    // Grid ve Eksenler
    ctx.beginPath(); ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
    // Basit grid
    for(let i=0; i<=5; i++) {
        let y = h - padding - (i/5)*(h-2*padding);
        ctx.moveTo(padding, y); ctx.lineTo(w-padding, y);
    }
    ctx.stroke();

    // Ã‡Ä°ZÄ°M FONKSÄ°YONLARI
    const mapX = (d) => padding + (d / maxDist) * (w - 2*padding);
    const mapY = (z) => h - padding - ((z - minZ) / rangeZ) * (h - 2*padding);

    // Profil Ã‡izgisi
    ctx.beginPath();
    ctx.strokeStyle = '#8e44ad'; ctx.lineWidth = 3;
    ctx.moveTo(mapX(profileData[0].distCum), mapY(profileData[0].z));
    
    for(let i=1; i<profileData.length; i++) {
        ctx.lineTo(mapX(profileData[i].distCum), mapY(profileData[i].z));
    }
    ctx.stroke();

    // Noktalar ve YazÄ±lar
    ctx.fillStyle = '#2c3e50'; ctx.font = '10px sans-serif'; ctx.textAlign = 'center';
    profileData.forEach(d => {
        const x = mapX(d.distCum);
        const y = mapY(d.z);
        
        ctx.beginPath(); ctx.arc(x, y, 4, 0, 2*Math.PI); ctx.fill();
        ctx.fillText(`${d.no}`, x, y - 15);
        ctx.fillText(`Z:${d.z.toFixed(2)}`, x, y - 5);
        ctx.fillText(`L:${d.distCum.toFixed(1)}`, x, h - 10);
    });
    
    // Eksen Etiketleri
    ctx.save();
    ctx.translate(15, h/2); ctx.rotate(-Math.PI/2); ctx.textAlign='center';
    ctx.fillText("KOT (Z)", 0, 0);
    ctx.restore();
    ctx.fillText("MESAFE (metre)", w/2, h-5);
}

function closeProfile() {
    document.getElementById('profile-modal').style.display = 'none';
}

function exportProfileExcel() {
    if(profileData.length === 0) return;
    
    const ws_data = [
        ["Nokta No", "Ara Mesafe (m)", "KÃ¼mÃ¼latif Mesafe (m)", "Kot (Z)"]
    ];
    
    profileData.forEach(d => {
        ws_data.push([d.no, d.distPartial.toFixed(3), d.distCum.toFixed(3), d.z.toFixed(3)]);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Boykesit");
    XLSX.writeFile(wb, "Boykesit_Verileri.xlsx");
}

// --- DÄ°ÄER MEVCUT FONKSÄ°YONLAR ---
function addMeasurePt(latlng) {
    measurePts.push(latlng);
    lyrTemp.clearLayers();
    if(measurePts.length > 1) L.polyline(measurePts, {color: '#f1c40f', weight: 3, dashArray: '10, 10'}).addTo(lyrTemp);
    measurePts.forEach(pt => L.circleMarker(pt, {radius:3, color:'#f1c40f'}).addTo(lyrTemp));
    let totalDist = 0;
    for(let i=0; i<measurePts.length-1; i++) totalDist += map.distance(measurePts[i], measurePts[i+1]);
    showInfo(`ğŸ“ CETVEL\nNokta: ${measurePts.length}\nToplam: ${totalDist.toFixed(3)} m\n(Bitirmek iÃ§in saÄŸ tÄ±k)`);
}

function addAreaPt(latlng) {
    areaPts.push(latlng);
    lyrTemp.clearLayers();
    if(areaPts.length > 2) {
        L.polygon(areaPts, {color: '#9b59b6', fillColor: '#9b59b6', fillOpacity: 0.3}).addTo(lyrTemp);
        let area = 0; let j = areaPts.length - 1;
        for (let i = 0; i < areaPts.length; i++) { area += (areaPts[j].lng + areaPts[i].lng) * (areaPts[j].lat - areaPts[i].lat); j = i; }
        area = Math.abs(area / 2.0);
        showInfo(`ğŸ“ ALAN\n${area.toFixed(3)} mÂ²\n(${(area/10000).toFixed(4)} Ha)\n(Bitirmek iÃ§in saÄŸ tÄ±k)`);
    } else {
        areaPts.forEach(pt => L.circleMarker(pt, {radius:3, color:'#9b59b6'}).addTo(lyrTemp));
        showInfo(`ğŸ“ ALAN: ${areaPts.length} nokta.\n(En az 3 nokta gerekli)`);
    }
}

function loadFile(input) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const isYX = confirm("DOSYA SIRALAMASI:\n[TAMAM] -> Y (SaÄŸa), X (YukarÄ±)\n[Ä°PTAL] -> X (YukarÄ±), Y (SaÄŸa)");
        const lines = e.target.result.split('\n'); pts = []; lns = [];
        lines.forEach(line => {
            const d = line.trim().split(/\s+/);
            if(d.length >= 3) {
                let id = d[0]; let val1 = parseFloat(d[1]); let val2 = parseFloat(d[2]); let z = parseFloat(d[3]) || 0;
                let lay = "0"; const m = line.match(/"([^"]+)"/); if(m) lay=m[1];
                if(!layerColors[lay]) layerColors[lay] = '#'+Math.floor(Math.random()*16777215).toString(16);
                let finalY, finalX; if(isYX) { finalX = val1; finalY = val2; } else { finalY = val1; finalX = val2; }
                if(!isNaN(finalY) && !isNaN(finalX)) pts.push({ id: id, y: finalY, x: finalX, z: z, layer: lay, color: layerColors[lay] });
            }
        });
        render(); zoomAll();
    };
    reader.readAsText(input.files[0]);
}

function autoLink(type) {
    saveState();
    const minD = type==='sequence' ? 0 : parseFloat(prompt("Min Mesafe?", "0.01"));
    const maxD = type==='sequence' ? 999999 : parseFloat(prompt("Max Mesafe?", "100.0"));
    if(isNaN(minD) || isNaN(maxD)) return;
    if (type === 'layer') {
        const groups = {}; pts.forEach(p => { if(!groups[p.layer]) groups[p.layer]=[]; groups[p.layer].push(p); });
        for(const k in groups) { const grp = groups[k]; for(let i=0; i<grp.length-1; i++) { const d = getDist(grp[i], grp[i+1]); if(d >= minD && d <= maxD) lns.push({from:grp[i], to:grp[i+1], layer:k, color:grp[i].color}); } }
    } else if (type === 'near') {
        pts.forEach((p1, i) => { pts.forEach((p2, j) => { if(i < j) { const d = getDist(p1, p2); if(d >= minD && d <= maxD) lns.push({from:p1, to:p2, layer:p1.layer, color:p1.color}); } }); });
    } else if (type === 'sequence') {
         for(let i=0; i<pts.length-1; i++) lns.push({from:pts[i], to:pts[i+1], layer:pts[i].layer, color:pts[i].color});
    }
    render();
}

function getDist(p1, p2) { return Math.sqrt((p1.x-p2.x)**2 + (p1.y-p2.y)**2); }
function addPoint(lat, lng) { pts.push({ id: "P"+(pts.length+1), y: lat, x: lng, z: 0, layer: "MANUEL", color: "#e67e22" }); render(); }
function handleLine(p) { if(!lineStart) { lineStart = p; showInfo("BitiÅŸ noktasÄ± seÃ§in..."); } else { saveState(); lns.push({ from: lineStart, to: p, layer: "HAT", color: "#fff" }); lineStart = null; hideInfo(); render(); } }
function cleanupLines() { lns = lns.filter(l => pts.includes(l.from) && pts.includes(l.to)); }
function highlightRow(i, scroll) { document.querySelectorAll('tr').forEach(r => r.classList.remove('selected-row')); const r = document.getElementById('row-'+i); if(r) { r.classList.add('selected-row'); if(scroll) r.scrollIntoView({ behavior: 'smooth', block: 'center' }); } }
function setMode(m) { 
    mode = m; lineStart = null; measurePts = []; areaPts = []; profilePts = []; lyrTemp.clearLayers(); hideInfo();
    document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-active'));
    const btn = document.getElementById('btn-'+ (m.includes('del')?m:m)); if(btn) btn.classList.add('btn-active');
    if(m==='measure') showInfo("ğŸ“ CETVEL: BaÅŸlangÄ±Ã§ noktasÄ±na tÄ±kla...");
    if(m==='area') showInfo("ğŸ“ ALAN: KÃ¶ÅŸe noktalarÄ±nÄ± seÃ§...");
    if(m==='profile') showInfo("ğŸ“‰ BOYKESÄ°T: GÃ¼zergah noktalarÄ±na sÄ±rasÄ±yla tÄ±kla...");
}
function resetMode() { mode = 'idle'; lyrTemp.clearLayers(); hideInfo(); document.querySelectorAll('.btn').forEach(b => b.classList.remove('btn-active')); }
function showInfo(msg) { const p = document.getElementById('info-panel'); p.style.display = 'block'; p.innerText = msg; }
function hideInfo() { document.getElementById('info-panel').style.display = 'none'; }
function zoomAll() { if(pts.length) map.fitBounds(L.featureGroup(pts.map(p=>L.marker([p.y,p.x]))).getBounds().pad(0.1)); }
function toggleAcc(el) { el.parentElement.classList.toggle('active'); }
function saveState() { if(history.length > 20) history.shift(); history.push(JSON.stringify({ pts, lns: lns.map(l => ({ fi: pts.indexOf(l.from), ti: pts.indexOf(l.to), la: l.layer, co: l.color })) })); }
function undo() { if(!history.length) return; const state = JSON.parse(history.pop()); pts = state.pts; lns = state.lns.map(l => ({ from: pts[l.fi], to: pts[l.ti], layer: l.la, color: l.co })); render(); }
function updateLayerList() { const cont = document.getElementById('layer-container'); cont.innerHTML = ''; [...new Set(pts.map(p => p.layer))].forEach(l => { const div = document.createElement('div'); div.className = 'layer-row'; const col = pts.find(p=>p.layer===l)?.color || '#fff'; div.innerHTML = `<span style="color:${col}">â— ${l}</span> <button onclick="toggleL('${l}')">${hiddenLayers.has(l)?'GÃ–STER':'GÄ°ZLE'}</button>`; cont.appendChild(div); }); }
function toggleL(l) { hiddenLayers.has(l) ? hiddenLayers.delete(l) : hiddenLayers.add(l); render(); }

function exportDXF() { let c = "0\nSECTION\n2\nENTITIES\n"; pts.forEach(p => c += `0\nPOINT\n8\n${p.layer}\n10\n${p.x}\n20\n${p.y}\n30\n${p.z}\n`); lns.forEach(l => c += `0\nLINE\n8\n${l.layer}\n10\n${l.from.x}\n20\n${l.from.y}\n30\n${l.from.z}\n11\n${l.to.x}\n21\n${l.to.y}\n31\n${l.to.z}\n`); c += "0\nENDSEC\n0\nEOF"; download(c, "proje.dxf"); }
function exportNCN() { download(pts.map(p => `${p.id} ${p.y.toFixed(3)} ${p.x.toFixed(3)} ${p.z.toFixed(3)} 0 "${p.layer}"`).join('\n'), "proje.ncn"); }
function exportXYZ() { download(pts.map(p => `${p.y.toFixed(3)} ${p.x.toFixed(3)} ${p.z.toFixed(3)}`).join('\n'), "proje.xyz"); }
function exportKML() { let k=`<?xml version="1.0"?><kml><Document>`; pts.forEach(p=>k+=`<Placemark><name>${p.id}</name><Point><coordinates>${p.x},${p.y},${p.z}</coordinates></Point></Placemark>`); k+=`</Document></kml>`; download(k,"proje.kml"); }
function exportJSON() { download(JSON.stringify(pts,null,2),"proje.json"); }
function exportXLS() { const ws=XLSX.utils.json_to_sheet(pts.map(p=>({No:p.id, Y:p.y, X:p.x, Z:p.z, Tabaka:p.layer}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Data"); XLSX.writeFile(wb,"proje.xlsx"); }
function download(c,n) { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([c])); a.download=n; a.click(); }

init();
</script>
</body>
</html>
